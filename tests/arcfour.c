#include "test.h"
#include "arcfour.h"
#include "../arcfour.h"

/* https://tools.ietf.org/html/rfc6229 */

START_TEST(test_rfc6229_1)
{
	struct arcfour_subkeys subkeys;
	unsigned char key[] = {0x01, 0x02, 0x03, 0x04, 0x05};
	unsigned char buf[32] = {};
	unsigned char ct[32] = {
		0xb2, 0x39, 0x63, 0x05, 0xf0, 0x3d, 0xc0, 0x27,
		0xcc, 0xc3, 0x52, 0x4a, 0x0a, 0x11, 0x18, 0xa8,
		0x69, 0x82, 0x94, 0x4f, 0x18, 0xfc, 0x82, 0xd5,
		0x89, 0xc4, 0x03, 0xa4, 0x7a, 0x0d, 0x09, 0x19,
	};

	arcfour_prepare_key(&subkeys, key, sizeof(key));
	arcfour_crypt(&subkeys, buf, buf, 32);
	ck_assert_byte_array_eq(ct, buf, 32);
}
END_TEST

START_TEST(test_rfc6229_2)
{
	struct arcfour_subkeys subkeys;
	unsigned char key[] = {0x01, 0x02, 0x03, 0x04, 0x05,
			       0x06, 0x07, 0x08, 0x09, 0x0a};
	unsigned char buf[32] = {};
	unsigned char ct[32] = {
		0xed, 0xe3, 0xb0, 0x46, 0x43, 0xe5, 0x86, 0xcc,
		0x90, 0x7d, 0xc2, 0x18, 0x51, 0x70, 0x99, 0x02,
		0x03, 0x51, 0x6b, 0xa7, 0x8f, 0x41, 0x3b, 0xeb,
		0x22, 0x3a, 0xa5, 0xd4, 0xd2, 0xdf, 0x67, 0x11
	};

	arcfour_prepare_key(&subkeys, key, sizeof(key));
	arcfour_crypt(&subkeys, buf, buf, 4);
	arcfour_crypt(&subkeys, buf +  4, buf +  4,  4);
	arcfour_crypt(&subkeys, buf +  8, buf +  8,  5);
	arcfour_crypt(&subkeys, buf + 13, buf + 13, 15);
	arcfour_crypt(&subkeys, buf + 28, buf + 28,  4);
	ck_assert_byte_array_eq(ct, buf, 32);
}
END_TEST

START_TEST(test_rfc6229_3)
{
	struct arcfour_subkeys subkeys;
	unsigned char key[] = {0x83, 0x32, 0x22, 0x77, 0x2a};
	unsigned char buf[32] = {};
	unsigned char ct[32] = {
		0x80, 0xad, 0x97, 0xbd, 0xc9, 0x73, 0xdf, 0x8a,
		0x2e, 0x87, 0x9e, 0x92, 0xa4, 0x97, 0xef, 0xda,
		0x20, 0xf0, 0x60, 0xc2, 0xf2, 0xe5, 0x12, 0x65,
		0x01, 0xd3, 0xd4, 0xfe, 0xa1, 0x0d, 0x5f, 0xc0
	};
	unsigned int i;

	arcfour_prepare_key(&subkeys, key, sizeof(key));
	for (i = 0; i < 32; i++)
		arcfour_crypt(&subkeys, buf + i, buf + i, 1);
	ck_assert_byte_array_eq(ct, buf, 32);
}
END_TEST

void register_arcfour_tests(struct TCase *test_case)
{
	tcase_add_test(test_case, test_rfc6229_1);
	tcase_add_test(test_case, test_rfc6229_2);
	tcase_add_test(test_case, test_rfc6229_3);
}
