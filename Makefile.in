CC = gcc
RM = rm -f
CFLAGS  = @CFLAGS@ -Wall -Ofast -fPIC
LIBS    = @LIBS@

LIBNAME = algo
LIB     = lib$(LIBNAME).so
SOURCES = $(wildcard *.c)
OBJECTS = $(SOURCES:%.c=%.o)

TEST_PROG    = tests/test
TEST_SOURCES = $(wildcard tests/*.c)
TEST_OBJECTS = $(TEST_SOURCES:%.c=%.o)
TEST_CFLAGS  = $(CFLAGS) $(shell pkg-config --cflags check)
TEST_LIBS    = $(LIBS) $(shell pkg-config --libs check)

ifndef V
QUIET_CC    = @echo "   CC    $@";
QUIET_LD    = @echo "   LINK  $@";
QUIET_GEN   = @echo "   GEN   $@";
endif


.PHONY: all install uninstall test clean

all: $(LIB)

include $(wildcard *.d tests/*.d)

$(LIB): $(OBJECTS)
	$(QUIET_LD) $(CC) -MMD -MP -shared $^ -o $@ $(CFLAGS) $(LIBS)

%.o: %.c
	$(QUIET_CC) $(CC) -MMD -MP -c $< -o $@ $(CFLAGS) $(LIBS)

test: $(TEST_PROG)
	LD_LIBRARY_PATH=$$(pwd) $(TEST_PROG)

install:
	install -m 0755 -d /usr/include/$(LIBNAME)
	install -m 0755 $(LIB) /usr/lib
	install -m 0644 $(patsubst %.c,%.h,$(wildcard *.c)) /usr/include/$(LIBNAME)

uninstall:
	$(RM) -r /usr/include/$(LIBNAME)
	$(RM) /usr/lib/$(LIB)

$(TEST_PROG): $(TEST_OBJECTS) $(LIB)
	$(QUIET_LD) $(CC) -MMD -MP $(TEST_OBJECTS) -o $@ $(TEST_CFLAGS) $(TEST_LIBS) -L. -l$(LIBNAME)

tests/%.o: tests/%.c
	$(QUIET_CC) $(CC) -MMD -MP -c $< -o $@ $(TEST_CFLAGS) $(TEST_LIBS)

clean:
	$(RM) $(TEST_PROG) *.so *.o */*.o */*.d *.d

distclean: clean
	$(RM) -r autom4te.cache
	$(RM) Makefile configure configure.scan
	$(RM) config.h* config.log config.status
	$(RM) aclocal.m4 install-sh
